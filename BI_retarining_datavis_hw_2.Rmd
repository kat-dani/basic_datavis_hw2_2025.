---
title: "BI_retarining_datavis_hw_2"
output: html_document
date: "2026-01-05"
---

```{r start_chunk, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
                      
library(gghalves, quietly = TRUE)
library(ggridges)
library(ggforce)
library(patchwork)
library(gghighlight)
library(ggthemes)
library(tidyplots)
library(ggpattern)
library(magick)
library(treemapify)
suppressPackageStartupMessages(library(ggExtra))
suppressPackageStartupMessages(library(ggmosaic))
suppressPackageStartupMessages(library(scales))
suppressPackageStartupMessages(library(tidyverse))
# library(ggimage) #не подходит для моей версии R (4.5.0)

options(scipen = 999)
```

```{r data_reading, include=FALSE}
hogwarts <- read_csv("data/hogwarts_2025.csv")
```

```{r custom_theme_set, include=FALSE}
theme_custom <- theme(
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 25),
    plot.title = element_text(size = 30, hjust = 0.5),
    plot.subtitle = element_text(size = 20, hjust = 0.5),
    legend.title = element_text(size = 20),
    legend.text = element_text(size = 15),
    panel.background = element_rect(fill = "white"), 
    panel.grid = element_blank()
  )

theme_set(theme_custom)
```


```{r translations_and_colours, include=FALSE}
exams_translating <- c(
 "Defence against the dark arts exam" = "ЗОТИ",
 "Flying exam" = "Полеты",
 "Astronomy exam" = "Астрономия",
 "Herbology exam" = "Травология",
 "Divinations exam" = "Прорицания",
 "Charms exam" = "Заклинания",
 "History of magic exam" = "История магии",
 "Arithmancy exam" = "Нумерология",                   
 "Muggle studies exam" = "Магловедение",
 "Study of ancient runes exam" = "Древние руны",
 "Transfiguration exam" = "Трансфигурация",
 "Potions exam" = "Зельеварение",                      
 "Care of magical creatures exam" = "Уход за магическими существами"
)

hogwarts_houses_names <- c(
      "Gryffindor" = "Гриффиндор",
      "Hufflepuff" = "Пуффендуй",
      "Ravenclaw" = "Когтевран",
      "Slytherin" = "Слизерин"
    )

hogwarts_houses_colours <- c(
      "Gryffindor" = "#C50000",
      "Hufflepuff" = "#ECB939",
      "Ravenclaw" = "#41A6D9",
      "Slytherin" = "#1F5D25"
    )

hogwarts_houses_fill <- scale_fill_manual(
    name = "Факультет",
    labels = hogwarts_houses_names,
    values = hogwarts_houses_colours
  )

hogwarts_houses_colour <- scale_colour_manual(
    name = "Факультет",
    labels = hogwarts_houses_names,
    values = hogwarts_houses_colours
  )

hogwarts_houses_x <- scale_x_discrete(
    name = "Факультет",
    labels = hogwarts_houses_names
)
```

## 1

```{r, fig.width=8, fig.height=6}

long_exam_hogwarts <- hogwarts |>
  pivot_longer(
    ends_with("exam"), names_to = "Exam", values_to = "Score"
  )

long_exam_hogwarts |>
  tidyplot(x = house, y = Score, color = Exam) |>
  add_barstack_absolute()+
  labs(
    title = "Сумма баллов за экзамены по факультетам",
    y = "Баллы",
    x = "Факультет")

# не смогла сделать его крупнее даже с настройками чанка, чтобы он оставался четким
# Но сам код короче и проще, чем делать то же самое через geom_bar, тем более что для geom_bar нельзя указать две оси, он сам считает количество в указанных категориях

```


## 2

```{r, fig.width=14, fig.height=9}

hogwarts_result_by_house_wand <- hogwarts |> 
  group_by(house, wandCore) |> 
  summarise(house_total_points = sum(result)) |> 
  unite(`house and wand core`, house, wandCore, sep = " & ", remove = FALSE) |> 
  ungroup()

ggplot(hogwarts_result_by_house_wand, aes(area = house_total_points, fill = house_total_points, label = `house and wand core`)) +
  geom_treemap() +
  geom_treemap_text(fontface = "italic", colour = "white", place = "centre",
                    grow = TRUE)+
    labs(
    title = "Количество баллов по факультетам и сердцевинам палочки",
     fill = "Баллы"
    )

```
Вывод: treemap вписывает все категории в квадрат, сортируя от наибольшей по количеству к меньшей, видимо по правилу золотого сечения. Для заполнения градиента нужно указывать переменную, в которой содержится уже подсчитанное число. Подходит для тех случаев, когда не обязательно видеть точное соотношение групп, когда есть количественная переменная, по которой нужно показать градацию изменений в группах (квадратах)
Мозаик-плот группирует категории в столбцы. Подсчет количества для ширины и длины столбика происходит автоматически, т.е. не нужно указывать, по какой переменной считать, т.к. считает количество записей. Этот тип графика подходит для тех случаев, когда нужно точнее увидеть соотношение между группами.

## 3

```{r, fig.width=16, fig.height=12}

students_5_course <- hogwarts |> 
  mutate(wandCore = as.factor(wandCore), id = as.factor(id))|>
  filter(course == 5)


hogwarts_wandCore_colours <- c(
      "phoenix feather" = "#ECB939",
      "dragon heartstring" = "#C50000",
      "unicorn hair" = "#ABABAB"
    ) 

hogwarts_wandCore_names <- c(
      "phoenix feather" = "Перо феникса",
      "dragon heartstring" = "Сердечная жила дракона",
      "unicorn hair" = "Волос единорога"
    ) 

ggplot(students_5_course, aes(x=reorder(id, -result), y= result, colour = wandCore)) +
  geom_segment(aes(y=0, yend=result), color="grey") +
  geom_point( size=4) +
  scale_colour_manual(
    values = hogwarts_wandCore_colours,
    name = "Сердцевина палочки", 
labels = hogwarts_wandCore_names
  ) +
  xlab("id Студента") +
  ylab("Количество баллов за учебный год")+
    labs(
    title = "Количество баллов по сердцевинам палочки студентов 5-го курса")+
  theme(
    panel.grid.major.x = element_blank(),
    panel.border = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.x = element_blank()
  )

```

## 4

Недостатки графика из дз:
1) На графике отображены рандомные недели, и не упорядочены.
2) Линия "треда" не нужна, на такой столбчатой диаграмма итак видна тенденция.
3) Легенда не интуитивно понятна, что год разбит на 6 частей по неделям. Также на легенде порядок недель неправильный.
4) Присутсвует вторая часть легенды только с одним названием цвета, это лишнее.
5) Подписи графика мелкие, цвета не контрастные к фону, надписи не читаемые. Заголовок мелкий, не центрирован, меньше по размеру чем подзаголовок.
6) график сильно вытянут по вертикали, а это манипулятивный прием, чтобы показать больший перепад по y.
7) Слишком частые деления на оси Y. Оси не подписаны "человеческим" языком.
8) Сетка также слишком частая и темная
9) Красная поясняющая стрелка слишком массивная: занимает большую часть графика и отвлекает на себя внимание от данных. Он вообще не нужна, т.к. в заметке, от которой она начинается, идет речь о начале обучения, а стрелка указывает на окончание года.
10) Фон такой пестрой картинкой - лишнее, неуместно для такого графика, мешает считывать график.
11) В связи с этим всем дана неверная интерпретация данных, из-за чего было принято радикальное решение об увольнении и штрафах.

Хорошее в это графике:
1) Добавлены подсказки в виде "заметок" и линий (в принципе само добавление их на график, а не их вид).
2) Добавлены доверительные интервалы для баллов на неделе (правда зачем, но вдруг кому-то очень нужно)
3) В интерпретации графика попытались найти причину найденной тенденции и предложить решение (опустим детали, какое)


```{r, fig.width=14, fig.height=9}

result_per_week_df <- hogwarts |> 
  pivot_longer(c(starts_with("week")), names_to = "week_number", values_to = "score") |>  # по неделям
  mutate(week_number = week_number |> str_split_i("_", 2) |> as.numeric()) |> 
  group_by(week_number) |> 
  summarise(result_per_week = sum(score),
            sd_per_week     = sd(score))

ggplot(result_per_week_df)+
  geom_col(aes(x = week_number, y = result_per_week, fill = result_per_week), colour = "black")+
  geom_errorbar( aes(x=week_number, ymin=result_per_week-sd_per_week, ymax=result_per_week+sd_per_week), width=0.4, colour="orange", alpha=0.9, size=1.3)+
  labs(
    title = "Сумма баллов за год по неделям",
    subtitle = "Хогвартс, 2024-2025 учебный год",
    x = "Неделя",
    y = "Баллы",
    fill = "Баллы" # Заголовок легенды
  )
```
Как видно по графику, баллы по неделям распределены довольно равномерно: есть спады и подъемы на всем протяжении графика. По данному графику мы не можем сделать вывод о наличии тенденции к "выгоранию" преподавателей или лени учащихся под конец года.

## 5

```{r, fig.width=5, fig.height=15}

# hint2 <- read_csv("data/podskazka2.csv")
# 
# ggplot(hint2, aes(x = `X`, y = `Y`))+
#   geom_point()

ms <- c(14,11,8,18,27,36)

result_per_week_df_1 <- hogwarts |> 
  pivot_longer(c(starts_with("week")), names_to = "week_number", values_to = "score") |>  # по неделям
  mutate(week_number = week_number |> str_split_i("_", 2) |> as.numeric()) |> 
  group_by(week_number) |> 
  summarise(result_per_week = sum(score),
            sd_per_week     = sd(score)) |>
  filter(week_number %in% c(14,11,8,18,27,36)) |> 
  mutate(week_number = as.factor(week_number))

ms <- c(14,11,8,18,27,36)

ggplot(result_per_week_df_1)+
  geom_col(aes(x = fct_reorder(week_number, ms), y = result_per_week, fill = week_number, alpha = 0.7), colour = "black")+
  geom_errorbar(aes(x=week_number, ymin=result_per_week-sd_per_week, ymax=result_per_week+sd_per_week), width=0.4, colour="black", size=1.5)+
    geom_line(aes(x = fct_reorder(week_number, ms), y=result_per_week, group = 1),
    colour = "black",
    size = 1
  ) +
  labs(
    title = "Эмоциональное выгорание преподавателей или лень учеников?",
    subtitle = "Dramatical decreasing of mean score for every subsequent week in Hogwarts"
  )+
  scale_y_continuous( # подписи для оси Y для количественной переменной
    name = "Балл",
    breaks = seq(0, 1000, 10) # отсечки на оси
  )+
    scale_fill_manual( # подписи для оси легенды, ручная настройка
    labels = c(
      "8" = "3/6",
      "11" = "2/6",
      "14" = "1/6",
      "18" = "4/6",
      "27" = "5/6",
      "36" = "6/6"
    ),
    values = c(
      "8" = "#CA3519",
      "11" = "#5EA529",
      "14" = "#7BF1A8",
      "18" = "#2984D1",
      "27" = "#7C86FF",
      "36" = "#79716B"
    )
  )+
  theme(
    axis.text = element_text(size = 5),
    axis.title = element_text(size = 5),
    plot.title = element_text(size = 8),
    plot.subtitle = element_text(size = 9, colour= "red"),
    legend.title = element_text(size = 5),
    legend.text = element_text(size = 5),
    panel.background = element_rect(fill = "orange"), # вместо изображения
    panel.grid.major.y = element_line(colour = "black")
  )

```
## 6

```{r, fig.width=18, fig.height=15}

set.seed(2025)

# ggplot(hogwarts)+
#   geom_bar(aes(x = house, fill = house), colour = "black")+
#   hogwarts_houses_x+
#   labs(
#     title = "Число студентов на факультетах Хогвартса",
#     y = "Число студентов"
#        )

# График-подложка
plotTemplate <- ggplot(result_per_week_df)+
  labs(title = "Histogram",
         y = "Баллы")+
theme(
    axis.text = element_text(size = 14),
    axis.title = element_text(size = 18),
    plot.title = element_text(size = 20, hjust = 0.5),
    panel.background = element_rect(fill = "white"), 
    panel.grid = element_blank()
  )

# Функция для подбора цвета
histBinCustom <- function(fill_n,
                          mapping = aes(x = week_number, y = result_per_week), 
                          color="black", ...){
  
  geom_col(mapping = mapping, colour = color, fill = fill_n)
  
}

# Создание конвеера
# res_colours <- colours() # не поняла, для чего эта строка
res_colours <- colours_[colours_ |> #R не смог скнитить из-за не найденного объекта colours_
str_detect("grey|gray|black|white", negate = TRUE)]|>
sample(size = 36)

histList <- map(res_colours, 
                \(x) plotTemplate+ 
                  histBinCustom(fill_n=x)+
                  scale_x_discrete(name = paste0(x, " colour")))

# Вывод итогового графика
wrap_plots(histList)+
  plot_annotation(
    title = "Расрпеделение баллов студентов Хогвартса по неделям",
    subtitle = "2024–2025 учебный год"
  )
```